<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />

		<!-- Styles -->
		<link rel='stylesheet prefetch' href='http://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css'>
		<link rel='stylesheet prefetch' href='http://fonts.googleapis.com/css?family=Roboto:500,100,300,700,400'>
		<link rel="stylesheet" href='http://fontawesome.io/assets/font-awesome/css/font-awesome.css'>
		<link rel="stylesheet" href="css/global.css">
		<link rel="stylesheet" href="css/bootstrap.min.css">
		<link rel="stylesheet" href="css/bootstrap-theme.min.css">
		<link rel="stylesheet" href="css/style.css">

		<!-- Scripts -->
		<script type="text/javascript" src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
		<script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
		<script src="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
		<script src='http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
		<script type="text/javascript" src="js/global.js"></script>
		<script type="text/javascript" src="js/index.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>

		<title>Validación de eventos</title>
	</head>
	<body>
		<!-- Header -->
		<div class="wrap">
			<div class="toggle-overlay">
			</div>
			<div class="left">
				<div class="left-head">
					<div class="top-bar">
						<div class="overlay">
						</div>
						<a class="search" href="#"><span class="ion-search"></span></a>
						<a class="setting" href="#"><span class="ion-android-more-vertical"></span></a>
					</div>
					<div class="user-bar">
						<img src="https://www.gobiernodecanarias.org/gcc/img/logos/logo.gif">
						<p class="name">AgendaCultural</p>
					</div>
				</div>
				<div class="menu-list">
					<a href="index.html" title="home">Eventos</a>
					<a href="ver-espacio.html" title="home">Espacios</a>
					<a href="eventsValidation.html" title="home">Validar Eventos</a>
					<a href="new-event.html" title="home">Crear Eventos</a>
				</div>
			</div><!--Left//-->

			<div class="header">
				<a href="#" class="toggle-btn"><span class="ion-navicon-round"></span></a>
				<a href="#" class="notification dropdown-toggle" data-toggle="dropdown"><i class="fa fa-user-circle-o"></i></a>
				<ul class="dropdown-menu dropdown-menu-right">
					<li><a href="login.html">Acceso</a></li>
					<li><a href="#">Salir</a></li>
				</ul>
				<a href="#" class="all"><span class="ion-android-search"></span></a>
			</div><!--header//-->
			<div class="header-All">
				<a class="active" href="#">
					<form>
						<button class="btn" type="submit">
						<i class="fa fa-search"></i>
						</button>
						<input type="text" class="txt" placeholder="Search..." />
					</form>
				</a>
			</div>
		</div>

		<!-- Body -->
		<div ng-app="app" >
			<div class="main">
				<h1 class="title">Validar eventos</h1>
				
					<form ng-submit="formEventsValidation()" ng-controller="formEventsController" method="post">
						<div class=" marginbot100">
							<div class="form">
								<div class="img">
									<img src="http://www.gobiernodecanarias.com/opencms8/export/sites/cultura/.content/galeria/eventos/cultura/{{imagen}}">
								</div>
								<div class="description">
									<h3>{{titulo}}</h3>
									<p><strong>Descripción: </strong>{{desc}}</p>
									<p><strong>Municipio: </strong> {{municipio}}</p>
									<p><strong>Espacio cultural: </strong>{{espacio}}</p>
									<p><strong>Lugar: </strong>{{lugar}}</p>
									<p><strong>Fecha inicio: </strong>{{fechaini}}</p>
									<p><strong>Fecha fin: </strong>{{fechafin}}</p>
									<p><strong>[+info] </strong><a href="{{masinfo}}" target="_blank">{{masinfo}}</a></p>
								</div>
								<button type="submit" class="btn btn-success" style="float: right; margin-left: 5px;">Validar</button>
								<button type="button" class="btn btn-danger" style="float: right;" onclick="nextEvent();">Rechazar</button>
								<br>
							</div>
						</div>
					</form>
				
			</div>
		</div>
		
		<script>
		
			var app = angular.module('app', []);
			var apiValidate = 'http://vps265793.ovh.net:3000/protectedapi/validate/';
			var apiList = 'http://vps265793.ovh.net:3000/api/event/notposted/';
			var apiMunicipio = 'http://vps265793.ovh.net:3000/api/town/';
			var apiEspacio = 'http://vps265793.ovh.net:3000/api/culturalspace/';
			var i = 0;
			var cookie =  document.cookie;
			//document.cookie = "i=0";
			
			console.log("Token: "+getCookie("token"));
			
			var app = angular.module('app', []);
			app.controller('formEventsController', function($scope, $http) {
				
				$http.get(apiList).then(function(response) {
					i = parseInt(getCookie("i"));
					var event = response.data.data;
					$scope.titulo = event[i].titulo;
					$http.get(apiEspacio+event[i].espacio).then(function(responseE) {
						var espCult = responseE.data.data;
						$scope.espacio = espCult.denominacion;
						$scope.lugar = espCult.direccion;
					});	
					$scope.imagen = event[i].imagen;
					//$scope.lugar = event[0].lugar;
					$scope.desc = event[i].descripcion;
					$http.get(apiMunicipio+event[i].municipio).then(function(responseM) {
						var municip = responseM.data.data;
						$scope.municipio = municip[0].desmuni;
					});	
					$scope.fechaini = event[i].fecini;
					$scope.fechafin = event[i].fecfin;
					$scope.masinfo = event[i].masinfo;
				});
				
				$scope.formEventsValidation = function() {
					var idEvent = "";
					$http.get(apiList).then(function(response) {
						var event = response.data.data;
						idEvent = event[i].id;
						
						var datos = JSON.stringify({
							"token" : getCookie("token"),
						});
						$http.post(apiValidate+idEvent, datos).
						success(function(response) {
							console.log("Evento validado correctamente");
							console.log("Id del evento validado: "+idEvent);
							location.reload(true);
							
						}).error(function(response) {
							console.log("Error: "+response);
							
						});
							
					});
		
				}
			});
			
			function nextEvent(){
				var index = parseInt(getCookie("i")) + 1;
				document.cookie = "i="+index;
				location.reload(true);
			}
			
		</script>
	</body>
</html>
